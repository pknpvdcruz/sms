'use strict';

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

/**
 * Determind if response is successful
 * @param {LazadaOpenPlatformAPIResponse} response
 * @return {boolean} success
 */


var _nodeFetch = require('node-fetch');

var _nodeFetch2 = _interopRequireDefault(_nodeFetch);

var _constants = require('./constants');

var _signature = require('./signature');

var _Common = require('../types/Common');

var _Request = require('./types/Request');

var _Response = require('./types/Response');

var _flowRuntime = require('flow-runtime');

var _flowRuntime2 = _interopRequireDefault(_flowRuntime);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var LazadaOpenPlatformAPIResponse = _flowRuntime2.default.tdz(function () {
  return _Response.LazadaOpenPlatformAPIResponse;
});

var SDKRequestMetaData = _flowRuntime2.default.tdz(function () {
  return _Request.SDKRequestMetaData;
});

var SystemQueryParams = _flowRuntime2.default.tdz(function () {
  return _Request.SystemQueryParams;
});

var KeyValueDictionary = _flowRuntime2.default.tdz(function () {
  return _Common.KeyValueDictionary;
});

var isResponseSuccessful = _flowRuntime2.default.annotate(function isResponseSuccessful(response) {
  var _responseType = _flowRuntime2.default.union(_flowRuntime2.default.ref(LazadaOpenPlatformAPIResponse), _flowRuntime2.default.any());

  var _returnType = _flowRuntime2.default.return(_flowRuntime2.default.boolean());

  _flowRuntime2.default.param('response', _responseType).assert(response);

  return _returnType.assert((typeof response === 'undefined' ? 'undefined' : _typeof(response)) === 'object' && response !== null && response.hasOwnProperty('code') && response.code === _constants.RESPONSE.SUCCESS.CODE);
}, _flowRuntime2.default.function(_flowRuntime2.default.param('response', _flowRuntime2.default.union(_flowRuntime2.default.ref(LazadaOpenPlatformAPIResponse), _flowRuntime2.default.any())), _flowRuntime2.default.return(_flowRuntime2.default.boolean())));

var handleLazadaResponse = _flowRuntime2.default.annotate(function handleLazadaResponse(response, meta) {
  var _responseType2 = _flowRuntime2.default.ref(LazadaOpenPlatformAPIResponse);

  var _metaType = _flowRuntime2.default.ref(SDKRequestMetaData);

  var _returnType2 = _flowRuntime2.default.return(_flowRuntime2.default.ref(LazadaOpenPlatformAPIResponse));

  _flowRuntime2.default.param('response', _responseType2).assert(response);

  _flowRuntime2.default.param('meta', _metaType).assert(meta);

  // for debug only
  var _log_request = _flowRuntime2.default.annotate(function _log_request(_arg, response) {
    var _t$ref$assert = _flowRuntime2.default.ref(SDKRequestMetaData).assert(_arg),
        method = _t$ref$assert.method,
        apiPath = _t$ref$assert.apiPath,
        payload = _t$ref$assert.payload,
        query = _t$ref$assert.query;

    console.info('[%s] '.replace(/%s/, method) + apiPath, ' ', payload, ' ', query);
    console.log(JSON.stringify(response, null, 2));
  }, _flowRuntime2.default.function(_flowRuntime2.default.param('_arg', _flowRuntime2.default.ref(SDKRequestMetaData)), _flowRuntime2.default.param('response', _flowRuntime2.default.any())));
  // _log_request(meta, response)
  if (isResponseSuccessful(response)) {
    return Promise.resolve(response).then(function (_arg2) {
      return _returnType2.assert(_arg2);
    });
  } else {
    return Promise.reject(response).then(function (_arg3) {
      return _returnType2.assert(_arg3);
    });
  }
}, _flowRuntime2.default.function(_flowRuntime2.default.param('response', _flowRuntime2.default.ref(LazadaOpenPlatformAPIResponse)), _flowRuntime2.default.param('meta', _flowRuntime2.default.ref(SDKRequestMetaData)), _flowRuntime2.default.return(_flowRuntime2.default.ref('Promise', _flowRuntime2.default.ref(LazadaOpenPlatformAPIResponse)))));

var get = _flowRuntime2.default.annotate(function get(base, appKey, appSecret, apiPath, accessToken, params) {
  var _baseType = _flowRuntime2.default.string();

  var _appKeyType = _flowRuntime2.default.string();

  var _appSecretType = _flowRuntime2.default.string();

  var _apiPathType = _flowRuntime2.default.string();

  var _accessTokenType = _flowRuntime2.default.nullable(_flowRuntime2.default.string());

  var _paramsType = _flowRuntime2.default.ref(KeyValueDictionary);

  var _returnType3 = _flowRuntime2.default.return(_flowRuntime2.default.ref(LazadaOpenPlatformAPIResponse));

  _flowRuntime2.default.param('base', _baseType).assert(base);

  _flowRuntime2.default.param('appKey', _appKeyType).assert(appKey);

  _flowRuntime2.default.param('appSecret', _appSecretType).assert(appSecret);

  _flowRuntime2.default.param('apiPath', _apiPathType).assert(apiPath);

  _flowRuntime2.default.param('accessToken', _accessTokenType).assert(accessToken);

  _flowRuntime2.default.param('params', _paramsType, true).assert(params);

  var qs = Object.assign({}, params, getSystemQueryParamObject(appKey, appSecret, apiPath, accessToken, params));
  var url = new URL(base + apiPath);
  Object.keys(qs).forEach(function (key) {
    return url.searchParams.append(key, params[key]);
  });

  return (0, _nodeFetch2.default)(url, {
    method: 'GET',
    qs: qs
  }).then(function (res) {
    return res.json();
  }).then(function (res) {
    return handleLazadaResponse(response, meta);
  }).then(function (_arg4) {
    return _returnType3.assert(_arg4);
  });
}, _flowRuntime2.default.function(_flowRuntime2.default.param('base', _flowRuntime2.default.string()), _flowRuntime2.default.param('appKey', _flowRuntime2.default.string()), _flowRuntime2.default.param('appSecret', _flowRuntime2.default.string()), _flowRuntime2.default.param('apiPath', _flowRuntime2.default.string()), _flowRuntime2.default.param('accessToken', _flowRuntime2.default.nullable(_flowRuntime2.default.string())), _flowRuntime2.default.param('params', _flowRuntime2.default.ref(KeyValueDictionary)), _flowRuntime2.default.return(_flowRuntime2.default.ref('Promise', _flowRuntime2.default.ref(LazadaOpenPlatformAPIResponse)))));

var post = _flowRuntime2.default.annotate(function post(base, appKey, appSecret, apiPath, accessToken, body) {
  var _baseType2 = _flowRuntime2.default.string();

  var _appKeyType2 = _flowRuntime2.default.string();

  var _appSecretType2 = _flowRuntime2.default.string();

  var _apiPathType2 = _flowRuntime2.default.string();

  var _accessTokenType2 = _flowRuntime2.default.nullable(_flowRuntime2.default.string());

  var _bodyType = _flowRuntime2.default.ref(KeyValueDictionary);

  var _returnType4 = _flowRuntime2.default.return(_flowRuntime2.default.ref(LazadaOpenPlatformAPIResponse));

  _flowRuntime2.default.param('base', _baseType2).assert(base);

  _flowRuntime2.default.param('appKey', _appKeyType2).assert(appKey);

  _flowRuntime2.default.param('appSecret', _appSecretType2).assert(appSecret);

  _flowRuntime2.default.param('apiPath', _apiPathType2).assert(apiPath);

  _flowRuntime2.default.param('accessToken', _accessTokenType2).assert(accessToken);

  _flowRuntime2.default.param('body', _bodyType, true).assert(body);

  // turns out even it's HTTP POST, Lazada expect `body` to be part of query string
  var qs = Object.assign({}, body, getSystemQueryParamObject(appKey, appSecret, apiPath, accessToken, body));
  var url = new URL(base + apiPath);
  Object.keys(qs).forEach(function (key) {
    return url.searchParams.append(key, params[key]);
  });

  return (0, _nodeFetch2.default)(url, {
    method: 'GET',
    body: body
  }).then(function (res) {
    return res.json();
  }).then(function (res) {
    return handleLazadaResponse(response, meta);
  }).then(function (_arg5) {
    return _returnType4.assert(_arg5);
  });
}, _flowRuntime2.default.function(_flowRuntime2.default.param('base', _flowRuntime2.default.string()), _flowRuntime2.default.param('appKey', _flowRuntime2.default.string()), _flowRuntime2.default.param('appSecret', _flowRuntime2.default.string()), _flowRuntime2.default.param('apiPath', _flowRuntime2.default.string()), _flowRuntime2.default.param('accessToken', _flowRuntime2.default.nullable(_flowRuntime2.default.string())), _flowRuntime2.default.param('body', _flowRuntime2.default.ref(KeyValueDictionary)), _flowRuntime2.default.return(_flowRuntime2.default.ref('Promise', _flowRuntime2.default.ref(LazadaOpenPlatformAPIResponse)))));

/**
 * Gather system and business parameters to compute signature
 * @param {string} appKey
 * @param {string} appSecret
 * @param {string} apiPath
 * @param {string?} accessToken
 * @param {KeyValueDictionary?} payload
 * @return {SystemQueryParams}
 */
var getSystemQueryParamObject = _flowRuntime2.default.annotate(function getSystemQueryParamObject(appKey, appSecret, apiPath, accessToken, payload) {
  var _appKeyType3 = _flowRuntime2.default.string();

  var _appSecretType3 = _flowRuntime2.default.string();

  var _apiPathType3 = _flowRuntime2.default.string();

  var _accessTokenType3 = _flowRuntime2.default.nullable(_flowRuntime2.default.string());

  var _payloadType = _flowRuntime2.default.ref(KeyValueDictionary);

  var _returnType5 = _flowRuntime2.default.return(_flowRuntime2.default.ref(SystemQueryParams));

  _flowRuntime2.default.param('appKey', _appKeyType3).assert(appKey);

  _flowRuntime2.default.param('appSecret', _appSecretType3).assert(appSecret);

  _flowRuntime2.default.param('apiPath', _apiPathType3).assert(apiPath);

  _flowRuntime2.default.param('accessToken', _accessTokenType3).assert(accessToken);

  _flowRuntime2.default.param('payload', _payloadType, true).assert(payload);

  var systemParams = _flowRuntime2.default.object(_flowRuntime2.default.property('app_key', _flowRuntime2.default.string()), _flowRuntime2.default.property('timestamp', _flowRuntime2.default.string()), _flowRuntime2.default.property('sign_method', _flowRuntime2.default.string()), _flowRuntime2.default.property('access_token', _flowRuntime2.default.string(), true)).assert({
    app_key: appKey,
    timestamp: Date.now().toString(),
    sign_method: 'sha256'
  });

  if (accessToken) {
    systemParams.access_token = accessToken;
  }

  return _returnType5.assert(Object.assign({}, {
    sign: (0, _signature.signRequest)(appSecret, apiPath, Object.assign({}, payload, systemParams))
  }, systemParams));
}, _flowRuntime2.default.function(_flowRuntime2.default.param('appKey', _flowRuntime2.default.string()), _flowRuntime2.default.param('appSecret', _flowRuntime2.default.string()), _flowRuntime2.default.param('apiPath', _flowRuntime2.default.string()), _flowRuntime2.default.param('accessToken', _flowRuntime2.default.nullable(_flowRuntime2.default.string())), _flowRuntime2.default.param('payload', _flowRuntime2.default.ref(KeyValueDictionary)), _flowRuntime2.default.return(_flowRuntime2.default.ref(SystemQueryParams))));

// constructor
module.exports = {
  get: get,
  post: post,
  isResponseSuccessful: isResponseSuccessful,
  // helper
  getSystemQueryParamObject: getSystemQueryParamObject
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9MYXphZGFSZXF1ZXN0L2luZGV4LmpzIl0sIm5hbWVzIjpbImlzUmVzcG9uc2VTdWNjZXNzZnVsIiwicmVzcG9uc2UiLCJoYXNPd25Qcm9wZXJ0eSIsImNvZGUiLCJSRVNQT05TRSIsIlNVQ0NFU1MiLCJDT0RFIiwiaGFuZGxlTGF6YWRhUmVzcG9uc2UiLCJtZXRhIiwiX2xvZ19yZXF1ZXN0IiwibWV0aG9kIiwiYXBpUGF0aCIsInBheWxvYWQiLCJxdWVyeSIsImNvbnNvbGUiLCJpbmZvIiwicmVwbGFjZSIsImxvZyIsIkpTT04iLCJzdHJpbmdpZnkiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImdldCIsImJhc2UiLCJhcHBLZXkiLCJhcHBTZWNyZXQiLCJhY2Nlc3NUb2tlbiIsInBhcmFtcyIsInFzIiwiT2JqZWN0IiwiYXNzaWduIiwiZ2V0U3lzdGVtUXVlcnlQYXJhbU9iamVjdCIsInVybCIsIlVSTCIsImtleXMiLCJmb3JFYWNoIiwic2VhcmNoUGFyYW1zIiwiYXBwZW5kIiwia2V5IiwidGhlbiIsInJlcyIsImpzb24iLCJwb3N0IiwiYm9keSIsImFwcF9rZXkiLCJ0aW1lc3RhbXAiLCJEYXRlIiwibm93IiwidG9TdHJpbmciLCJzaWduX21ldGhvZCIsInN5c3RlbVBhcmFtcyIsImFjY2Vzc190b2tlbiIsInNpZ24iLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFDQTs7OztBQVVBOzs7Ozs7O0FBUkE7Ozs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBT0EsSUFBTUEsc0RBQXVCLDhCQUMzQkMsUUFEMkIsRUFFZjtBQUFBLHNCQURKLDRCQUFFLHdEQUFGLEVBQWtDLDJCQUFsQyxDQUNJOztBQUFBLGlEQUFYLCtCQUFXOztBQUFBOztBQUNaLDRCQUNFLFFBQU9BLFFBQVAseUNBQU9BLFFBQVAsT0FBb0IsUUFBcEIsSUFDQUEsYUFBYSxJQURiLElBRUFBLFNB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LGdDQU1qQyw0Q0FOaUMsRUFBNUIsQ0FBTjs7QUFtQ0E7QUFDQUcsT0FBT0MsT0FBUCxHQUFpQjtBQUNmaEMsT0FBS0EsR0FEVTtBQUVmb0IsUUFBTUEsSUFGUztBQUdmM0Msd0JBQXNCQSxvQkFIUDtBQUlmO0FBQ0FnQyw2QkFBMkJBO0FBTFosQ0FBakIiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuJ3VzZSBzdHJpY3QnXG5cbmltcG9ydCBmZXRjaCBmcm9tICdub2RlLWZldGNoJ1xuXG5pbXBvcnQgeyBSRVNQT05TRSB9IGZyb20gJy4vY29uc3RhbnRzJ1xuaW1wb3J0IHsgc2lnblJlcXVlc3QgfSBmcm9tICcuL3NpZ25hdHVyZSdcbmltcG9ydCB0eXBlIHsgS2V5VmFsdWVEaWN0aW9uYXJ5IH0gZnJvbSAnc3JjL3R5cGVzL0NvbW1vbidcbmltcG9ydCB0eXBlIHsgU0RLUmVxdWVzdE1ldGFEYXRhLCBTeXN0ZW1RdWVyeVBhcmFtcyB9IGZyb20gJy4vdHlwZXMvUmVxdWVzdCdcbmltcG9ydCB0eXBlIHsgTGF6YWRhT3BlblBsYXRmb3JtQVBJUmVzcG9uc2UgfSBmcm9tICcuL3R5cGVzL1Jlc3BvbnNlJ1xuXG4vKipcbiAqIERldGVybWluZCBpZiByZXNwb25zZSBpcyBzdWNjZXNzZnVsXG4gKiBAcGFyYW0ge0xhemFkYU9wZW5QbGF0Zm9ybUFQSVJlc3BvbnNlfSByZXNwb25zZVxuICogQHJldHVybiB7Ym9vbGVhbn0gc3VjY2Vzc1xuICovXG5jb25zdCBpc1Jlc3BvbnNlU3VjY2Vzc2Z1bCA9IChcbiAgcmVzcG9uc2U6IExhemFkYU9wZW5QbGF0Zm9ybUFQSVJlc3BvbnNlIHwgYW55LFxuKTogYm9vbGVhbiA9PiB7XG4gIHJldHVybiAoXG4gICAgdHlwZW9mIHJlc3BvbnNlID09PSAnb2JqZWN0JyAmJlxuICAgIHJlc3BvbnNlICE9PSBudWxsICYmXG4gICAgcmVzcG9uc2UuaGFzT3duUHJvcGVydHkoJ2NvZGUnKSAmJlxuICAgIHJlc3BvbnNlLmNvZGUgPT09IFJFU1BPTlNFLlNVQ0NFU1MuQ09ERVxuICApXG59XG5cbmNvbnN0IGhhbmRsZUxhemFkYVJlc3BvbnNlID0gKFxuICByZXNwb25zZTogTGF6YWRhT3BlblBsYXRmb3JtQVBJUmVzcG9uc2UsXG4gIG1ldGE6IFNES1JlcXVlc3RNZXRhRGF0YSxcbik6IFByb21pc2U8TGF6YWRhT3BlblBsYXRmb3JtQVBJUmVzcG9uc2U+ID0+IHtcbiAgLy8gZm9yIGRlYnVnIG9ubHlcbiAgY29uc3QgX2xvZ19yZXF1ZXN0ID0gKFxuICAgIHsgbWV0aG9kLCBhcGlQYXRoLCBwYXlsb2FkLCBxdWVyeSB9OiBTREtSZXF1ZXN0TWV0YURhdGEsXG4gICAgcmVzcG9uc2UsXG4gICkgPT4ge1xuICAgIGNvbnNvbGUuaW5mbyhcbiAgICAgICdbJXNdICcucmVwbGFjZSgvJXMvLCBtZXRob2QpICsgYXBpUGF0aCxcbiAgICAgICcgJyxcbiAgICAgIHBheWxvYWQsXG4gICAgICAnICcsXG4gICAgICBxdWVyeSxcbiAgICApXG4gICAgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkocmVzcG9uc2UsIG51bGwsIDIpKVxuICB9XG4gIC8vIF9sb2dfcmVxdWVzdChtZXRhLCByZXNwb25zZSlcbiAgaWYgKGlzUmVzcG9uc2VTdWNjZXNzZnVsKHJlc3BvbnNlKSkge1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUocmVzcG9uc2UpXG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIFByb21pc2UucmVqZWN0KHJlc3BvbnNlKVxuICB9XG59XG5cbmNvbnN0IGdldCA9IChcbiAgYmFzZTogc3RyaW5nLFxuICBhcHBLZXk6IHN0cmluZyxcbiAgYXBwU2VjcmV0OiBzdHJpbmcsXG4gIGFwaVBhdGg6IHN0cmluZyxcbiAgYWNjZXNzVG9rZW46ID9zdHJpbmcsXG4gIHBhcmFtcz86IEtleVZhbHVlRGljdGlvbmFyeSxcbik6IFByb21pc2U8TGF6YWRhT3BlblBsYXRmb3JtQVBJUmVzcG9uc2U+ID0+IHtcbiAgY29uc3QgcXMgPSBPYmplY3QuYXNzaWduKFxuICAgIHt9LFxuICAgIHBhcmFtcyxcbiAgICBnZXRTeXN0ZW1RdWVyeVBhcmFtT2JqZWN0KGFwcEtleSwgYXBwU2VjcmV0LCBhcGlQYXRoLCBhY2Nlc3NUb2tlbiwgcGFyYW1zKSxcbiAgKVxuICBjb25zdCB1cmwgPSBuZXcgVVJMKGJhc2UgKyBhcGlQYXRoKTtcbiAgT2JqZWN0LmtleXMocXMpLmZvckVhY2goa2V5ID0+IHVybC5zZWFyY2hQYXJhbXMuYXBwZW5kKGtleSwgcGFyYW1zW2tleV0pKVxuICBcbiAgcmV0dXJuIGZldGNoKHVybCwge1xuICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgcXMsXG4gIH0pXG4gIC50aGVuKHJlcyA9PiByZXMuanNvbigpKVxuICAudGhlbihyZXMgPT4ge1xuICAgIHJldHVybiBoYW5kbGVMYXphZGFSZXNwb25zZShyZXNwb25zZSwgbWV0YSlcbiAgfSlcbn1cblxuY29uc3QgcG9zdCA9IChcbiAgYmFzZTogc3RyaW5nLFxuICBhcHBLZXk6IHN0cmluZyxcbiAgYXBwU2VjcmV0OiBzdHJpbmcsXG4gIGFwaVBhdGg6IHN0cmluZyxcbiAgYWNjZXNzVG9rZW46ID9zdHJpbmcsXG4gIGJvZHk/OiBLZXlWYWx1ZURpY3Rpb25hcnksXG4pOiBQcm9taXNlPExhemFkYU9wZW5QbGF0Zm9ybUFQSVJlc3BvbnNlPiA9PiB7XG4gIC8vIHR1cm5zIG91dCBldmVuIGl0J3MgSFRUUCBQT1NULCBMYXphZGEgZXhwZWN0IGBib2R5YCB0byBiZSBwYXJ0IG9mIHF1ZXJ5IHN0cmluZ1xuICBjb25zdCBxcyA9IE9iamVjdC5hc3NpZ24oXG4gICAge30sXG4gICAgYm9keSxcbiAgICBnZXRTeXN0ZW1RdWVyeVBhcmFtT2JqZWN0KGFwcEtleSwgYXBwU2VjcmV0LCBhcGlQYXRoLCBhY2Nlc3NUb2tlbiwgYm9keSksXG4gIClcbiAgY29uc3QgdXJsID0gbmV3IFVSTChiYXNlICsgYXBpUGF0aCk7XG4gIE9iamVjdC5rZXlzKHFzKS5mb3JFYWNoKGtleSA9PiB1cmwuc2VhcmNoUGFyYW1zLmFwcGVuZChrZXksIHBhcmFtc1trZXldKSlcbiAgXG4gIHJldHVybiBmZXRjaCh1cmwsIHtcbiAgICBtZXRob2Q6ICdHRVQnLFxuICAgIGJvZHlcbiAgfSlcbiAgLnRoZW4ocmVzID0+IHJlcy5qc29uKCkpXG4gIC50aGVuKHJlcyA9PiB7XG4gICAgcmV0dXJuIGhhbmRsZUxhemFkYVJlc3BvbnNlKHJlc3BvbnNlLCBtZXRhKVxuICB9KVxufVxuXG4vKipcbiAqIEdhdGhlciBzeXN0ZW0gYW5kIGJ1c2luZXNzIHBhcmFtZXRlcnMgdG8gY29tcHV0ZSBzaWduYXR1cmVcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcHBLZXlcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcHBTZWNyZXRcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcGlQYXRoXG4gKiBAcGFyYW0ge3N0cmluZz99IGFjY2Vzc1Rva2VuXG4gKiBAcGFyYW0ge0tleVZhbHVlRGljdGlvbmFyeT99IHBheWxvYWRcbiAqIEByZXR1cm4ge1N5c3RlbVF1ZXJ5UGFyYW1zfVxuICovXG5jb25zdCBnZXRTeXN0ZW1RdWVyeVBhcmFtT2JqZWN0ID0gKFxuICBhcHBLZXk6IHN0cmluZyxcbiAgYXBwU2VjcmV0OiBzdHJpbmcsXG4gIGFwaVBhdGg6IHN0cmluZyxcbiAgYWNjZXNzVG9rZW46ID9zdHJpbmcsXG4gIHBheWxvYWQ/OiBLZXlWYWx1ZURpY3Rpb25hcnksXG4pOiBTeXN0ZW1RdWVyeVBhcmFtcyA9PiB7XG4gIGNvbnN0IHN5c3RlbVBhcmFtczoge1xuICAgIGFwcF9rZXk6IHN0cmluZyxcbiAgICB0aW1lc3RhbXA6IHN0cmluZyxcbiAgICBzaWduX21ldGhvZDogc3RyaW5nLFxuICAgIGFjY2Vzc190b2tlbj86IHN0cmluZyxcbiAgfSA9IHtcbiAgICBhcHBfa2V5OiBhcHBLZXksXG4gICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLnRvU3RyaW5nKCksXG4gICAgc2lnbl9tZXRob2Q6ICdzaGEyNTYnLFxuICB9XG5cbiAgaWYgKGFjY2Vzc1Rva2VuKSB7XG4gICAgc3lzdGVtUGFyYW1zLmFjY2Vzc190b2tlbiA9IGFjY2Vzc1Rva2VuXG4gIH1cblxuICByZXR1cm4gT2JqZWN0LmFzc2lnbihcbiAgICB7fSxcbiAgICB7XG4gICAgICBzaWduOiBzaWduUmVxdWVzdChcbiAgICAgICAgYXBwU2VjcmV0LFxuICAgICAgICBhcGlQYXRoLFxuICAgICAgICBPYmplY3QuYXNzaWduKHt9LCBwYXlsb2FkLCBzeXN0ZW1QYXJhbXMpLFxuICAgICAgKSxcbiAgICB9LFxuICAgIHN5c3RlbVBhcmFtcyxcbiAgKVxufVxuXG4vLyBjb25zdHJ1Y3RvclxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIGdldDogZ2V0LFxuICBwb3N0OiBwb3N0LFxuICBpc1Jlc3BvbnNlU3VjY2Vzc2Z1bDogaXNSZXNwb25zZVN1Y2Nlc3NmdWwsXG4gIC8vIGhlbHBlclxuICBnZXRTeXN0ZW1RdWVyeVBhcmFtT2JqZWN0OiBnZXRTeXN0ZW1RdWVyeVBhcmFtT2JqZWN0LFxufVxuIl19